#!/usr/bin/php -q
<?php
/*Greasy, last time you edited this file you made all the text come out as the shadow colour,
black on many images.
The problem SHOULD be fixed and I've also modded the code a little bit so it should execute faster.
Spacing has been removed along with the CPS and KPS if statements.
*/

ini_set('max_execution_time',360);
include('config.php');
//start timer
$stimer = explode( ' ', microtime() );
$stimer = $stimer[1] + $stimer[0];


$content = file_get_contents("bounceme.xml");

/*
if (isset($_GET['user'])){
$username = prepforpreg($_GET['user']);
}
else {
$username = '.*?';
}*/


$query = 'select user from whatpulse';

$result = mysql_query($query, $connect);

while($row = mysql_fetch_assoc($result)) {

	$data = getData(prepforpreg($row['user']),$content);

	updateData($data,$connect);
}
$query = 'select * from whatpulse';

$result = mysql_query($query,$connect);
//$x = 1;

while($data = mysql_fetch_assoc($result)) {

	$im = imagecreatetruecolor($data['width'],$data['height']);
	$bg = mysql_fetch_assoc(mysql_query("SELECT * FROM `backgrounds` WHERE `id` = '$data[theme]'"));
	switch ($bg[type]) {
		case "image/png":
		$im2 = imagecreatefrompng($bg[path]);
		break;
		case "image/jpeg":
		$im2 = imagecreatefromjpeg($bg[path]);
		break;
		case "image/gif":
		$im2 = imagecreatefromgif($bg[path]);
		break;
	}
	imagecopy($im, $im2,  0, 0, 0, 0, $data['width'], $data['height']);
	$fontcolor = imagecolorallocate($im, $data['fontred'], $data['fontgreen'], $data['fontblue']);
	$shadow = imagecolorallocate($im, $data['sred'], $data['sgreen'], $data['sblue']);
	$blk = imagecolorallocate($im, 0, 0, 0);
	if ($data[be]) {
		imagerectangle($im,0,0,$data['width']-1,$data['height']-1,$blk);
	}

	if ($data['se']) {
		if ($data['usere']) {
			imagettftext($im,$data['fontsize'],0,$data['userx']+1,$data['usery']+1,$shadow,'fonts/' . $data['font'] . '.ttf',"User: " . $data['user']);
			imagettftext($im,$data['fontsize'],0,$data['userx'],$data['usery'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"User: " . $data['user']);
		}
		if ($data['tkce']) {
			imagettftext($im,$data['fontsize'],0,$data['tkcx']+1,$data['tkcy']+1,$shadow,'fonts/' . $data['font'] . '.ttf',"Keys: " . number_format($data['tkc']));
			imagettftext($im,$data['fontsize'],0,$data['tkcx'],$data['tkcy'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Keys: " . number_format($data['tkc']));
		}
		if ($data['tmce']) {
			imagettftext($im,$data['fontsize'],0,$data['tmcx']+1,$data['tmcy']+1,$shadow,'fonts/' . $data['font'] . '.ttf',"Clicks: " . number_format($data['tmc']));
			imagettftext($im,$data['fontsize'],0,$data['tmcx'],$data['tmcy'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Clicks: " . number_format($data['tmc']));
		}
		if ($data['ranke']) {
			imagettftext($im,$data['fontsize'],0,$data['rankx']+1,$data['ranky']+1,$shadow,'fonts/' . $data['font'] . '.ttf',"Rank: " . number_format($data['rank']));
			imagettftext($im,$data['fontsize'],0,$data['rankx'],$data['ranky'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Rank: " . number_format($data['rank']));
		}
		if ($data['tnamee']) {
			imagettftext($im,$data['fontsize'],0,$data['tnamex']+1,$data['tnamey']+1,$shadow,'fonts/' . $data['font'] . '.ttf',"Team Name: " . $data['tname']);
			imagettftext($im,$data['fontsize'],0,$data['tnamex'],$data['tnamey'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Team Name: " . $data['tname']);
		}
		if ($data['countrye']) {
			imagettftext($im,$data['fontsize'],0,$data['countryx']+1,$data['countryy']+1,$shadow,'fonts/' . $data['font'] . '.ttf',"Country: " . $data['country']);
			imagettftext($im,$data['fontsize'],0,$data['countryx'],$data['countryy'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Country: " . $data['country']);
		}
		if ($data['tkeyse']) {
			imagettftext($im,$data['fontsize'],0,$data['tkeysx']+1,$data['tkeysy']+1,$shadow,'fonts/' . $data['font'] . '.ttf',"Team Keys: " . number_format($data['tkeys']));
			imagettftext($im,$data['fontsize'],0,$data['tkeysx'],$data['tkeysy'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Team Keys: " . number_format($data['tkeys']));
		}
		if ($data['tclickse']) {
			imagettftext($im,$data['fontsize'],0,$data['tclicksx']+1,$data['tclicksy']+1,$shadow,'fonts/' . $data['font'] . '.ttf',"Team Clicks: " . number_format($data['tclicks']));
			imagettftext($im,$data['fontsize'],0,$data['tclicksx'],$data['tclicksy'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Team Clicks: " . number_format($data['tclicks']));
		}
		if ($data['tranke']) {
			imagettftext($im,$data['fontsize'],0,$data['trankx']+1,$data['tranky']+1,$shadow,'fonts/' . $data['font'] . '.ttf',"Team Rank: " . number_format($data['trank']) . "/" . number_format($data['tmembers']));
			imagettftext($im,$data['fontsize'],0,$data['trankx'],$data['tranky'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Team Rank: " . number_format($data['trank']) . "/" . number_format($data['tmembers']));
		}
	}


	if ($data['usere']) {
		imagettftext($im,$data['fontsize'],0,$data['userx'],$data['usery'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"User: " . $data['user']);
	}
	if ($data['tkce']) {
		imagettftext($im,$data['fontsize'],0,$data['tkcx'],$data['tkcy'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Keys: " . number_format($data['tkc']));
	}
	if ($data['tmce']) {
		imagettftext($im,$data['fontsize'],0,$data['tmcx'],$data['tmcy'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Clicks: " . number_format($data['tmc']));
	}
	if ($data['ranke']) {
		imagettftext($im,$data['fontsize'],0,$data['rankx'],$data['ranky'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Rank: " . number_format($data['rank']));
	}
	if ($data['tnamee']) {
		imagettftext($im,$data['fontsize'],0,$data['tnamex'],$data['tnamey'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Team Name: " . $data['tname']);
	}
	if ($data['countrye']) {
		imagettftext($im,$data['fontsize'],0,$data['countryx'],$data['countryy'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Country: " . $data['country']);
	}
	if ($data['tkeyse']) {
		imagettftext($im,$data['fontsize'],0,$data['tkeysx'],$data['tkeysy'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Team Keys: " . number_format($data['tkeys']));
	}
	if ($data['tclickse']) {

		imagettftext($im,$data['fontsize'],0,$data['tclicksx'],$data['tclicksy'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Team Clicks: " . number_format($data['tclicks']));
	}
	if ($data['tranke']) {
		imagettftext($im,$data['fontsize'],0,$data['trankx'],$data['tranky'],$fontcolor,'fonts/' . $data['font'] . '.ttf',"Team Rank: " . number_format($data['trank']) . "/" . number_format($data['tmembers']));
	}
	$file = "sig/".$data['user'].".png";

	imagepng($im,$file);

	imagedestroy($im);
	/*
	echo "Data set $x: <br /><br />";
	foreach ($data as $key => $value) {


	echo $key ." = ".$value."<br /><br />";
	}

	$x++;*/
}


$etimer = explode( ' ', microtime() );
$etimer = $etimer[1] + $etimer[0];

echo '<p style="margin:auto; text-align:center">';
printf( "Script timer: <b>%f</b> seconds.", ($etimer-$stimer) );
echo '</p>';

function getData($username,$content) {

	$data = array();
	$matches = array();
	$newmatch = array();
	$newmatch2 = array();

	preg_match_all('/<user="('.$username.')">(.*?)<\/user>/s',$content,$matches,PREG_PATTERN_ORDER);

	$users = count($matches[1]);

	for ($x = 0; $x < $users; $x++) {
		preg_match_all("/<.*>(.*)<\/.*>/",$matches[2][$x],$newmatch,PREG_PATTERN_ORDER);
		$data[$x] = array (
		'username' => $matches[1][$x],
		'country' => $newmatch[1][0],
		'globalrank' => $newmatch[1][1],
		'globalkeys' => preg_replace("/,/","",$newmatch[1][2]),
		'globalclicks' => preg_replace("/,/","",$newmatch[1][3]));


		if(preg_match("/<team=\"(.*)\">/",$matches[2][$x],$newmatch2)){
			$data[$x]['team'] = TRUE;
			$data[$x]['teamname'] = $newmatch2[1];
			$var = explode(" of ", $newmatch[1][4]);
			$data[$x]['teammembers'] = $var[1];
			$data[$x]['teamrank'] = $var[0];
			$data[$x]['teamkeys'] = preg_replace("/,/","",$newmatch[1][5]);
			$data[$x]['teamclicks'] = preg_replace("/,/","",$newmatch[1][6]);
		}
		else{
			$data[$x]['team'] = FALSE;
		}
	}

	/*for ($x = 0; $x < $users; $x++){
	echo "<pre>User Name (". ($x + 1) ."): ".$data[$x]['username'] . '<br />';
	echo "Country: ".$data[$x]['country'] . '<br />';
	echo "Rank: ".$data[$x]['globalrank'] . '<br />';
	echo "Keys: ".$data[$x]['globalkeys'] . '<br />';
	echo "Clicks: ".$data[$x]['globalclicks'] . '<br />';
	if ($data[$x]['team']) {
	echo "Team Name: ".$data[$x]['teamname'] . '<br />';
	echo "Team Rank: ".$data[$x]['teamrank'] .'/'. $data[$x]['teammembers']  . '<br />';
	echo "Team Keys: ".$data[$x]['teamkeys'] . '<br />';
	echo "Team Clicks: ".$data[$x]['teamclicks'] . '<br />';
	}
	}*/

	return $data;

}

function prepforpreg($var){

	$var = addcslashes($var,'[,],/,~,\\');
	$var = addcslashes($var,'(,),|,^,-');
	$var = addcslashes($var,'?,!,$,*');

	return $var;
}

function insertData($data,$dbconn) {
	$x=0;
	if ($data[0]['team']) {

		$query = "INSERT IGNORE INTO `whatpulse` "
		. "(`user` , `tkc` , `tmc` , `rank` , `tname` , `tkeys` , `tclicks` , `trank` , `country`, `tmembers`)"
		. "VALUES ( '" . $data[$x]['username']
		. "', '" . $data[$x]['globalkeys']
		. "', '" . $data[$x]['globalclicks']
		. "', '" . $data[$x]['globalrank']
		. "', '" . $data[$x]['teamname']
		. "', '" . $data[$x]['teamkeys']
		. "', '" . $data[$x]['teamclicks']
		. "', '" . $data[$x]['teamrank']
		. "', '" . $data[$x]['country']
		. "', '" . $data[$x]['teammembers'] . "')";
	}

	else {

		$query = "INSERT IGNORE INTO `whatpulse` "
		. "(`user` , `tkc` , `tmc` , `rank` , `country`)"
		. "VALUES ( '" . $data[$x]['username']
		. "', '" . $data[$x]['globalkeys']
		. "', '" . $data[$x]['globalclicks']
		. "', '" . $data[$x]['globalrank']
		. "', '" . $data[$x]['country'] . "')";
	}
	$query = mysql_escape_string($query);

	$result = mysql_query($query,$dbconn);
	if(!$result) {

		die("MySQL ERROR: " . mysql_error());
	}

	if(mysql_affected_rows($dbconn) < 1) {

		die("Zero Affected Rows - Query Failed.");
	}

}

function updateData($data,$dbconn) {

	if ($data[0]['team']) {
		$query = "UPDATE `whatpulse` SET "
		. "tkc = '" . $data[0]['globalkeys']
		. "', tmc = '" . $data[0]['globalclicks']
		. "', rank ='" . $data[0]['globalrank']
		. "', tname ='" . mysql_escape_string($data[0]['teamname'])
		. "', tkeys ='" . $data[0]['teamkeys']
		. "', tclicks ='" . $data[0]['teamclicks']
		. "', trank ='" . $data[0]['teamrank']
		. "', country ='" . mysql_escape_string($data[0]['country'])
		. "', tmembers = '" . $data[0]['teammembers'] ."' where user = '" . $data[0]['username'] . "'";

	}

	else {

		$query = "UPDATE `whatpulse` SET "
		. "tkc = '" . $data[0]['globalkeys']
		. "', tmc = '" . $data[0]['globalclicks']
		. "', rank ='" . $data[0]['globalrank']
		. "', country ='" . $data[0]['country']."' where user = '" . $data[0]['username'] . "'";
	}

	$result = mysql_query($query,$dbconn);

	if(!$result) {

		die("MySQL ERROR: " . mysql_error());
	}

	/*if(mysql_affected_rows($dbconn) < 1) {

	die("Zero Affected Rows - Query Failed.");
	}*/
}
?> 
